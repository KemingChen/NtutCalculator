var criterions = {"1001001":{"category":"△","subjectId":"1001001","remark":"　"},"1004001":{"category":"☆","subjectId":"1004001","remark":"　"},"1004002":{"category":"☆","subjectId":"1004002","remark":"　"},"1101001":{"category":"△","subjectId":"1101001","remark":"　"},"1101002":{"category":"△","subjectId":"1101002","remark":"　"},"1102004":{"category":"☆","subjectId":"1102004","remark":"　"},"1102005":{"category":"☆","subjectId":"1102005","remark":"　"},"1400026":{"category":"△","subjectId":"1400026","remark":"　"},"1400027":{"category":"△","subjectId":"1400027","remark":"　"},"1400028":{"category":"△","subjectId":"1400028","remark":"　"},"1400098":{"category":"△","subjectId":"1400098","remark":"　"},"1400099":{"category":"△","subjectId":"1400099","remark":"　"},"1401032":{"category":"▲","subjectId":"1401032","remark":"＊"},"1401041":{"category":"▲","subjectId":"1401041","remark":"＊"},"1401043":{"category":"▲","subjectId":"1401043","remark":"＊"},"1404003":{"category":"△","subjectId":"1404003","remark":"　"},"1419981":{"category":"△","subjectId":"1419981","remark":"　"},"1419982":{"category":"△","subjectId":"1419982","remark":"　"},"1419983":{"category":"△","subjectId":"1419983","remark":"　"},"1419984":{"category":"△","subjectId":"1419984","remark":"　"},"1419985":{"category":"△","subjectId":"1419985","remark":"　"},"1419991":{"category":"△","subjectId":"1419991","remark":"　"},"1419992":{"category":"△","subjectId":"1419992","remark":"　"},"1419993":{"category":"△","subjectId":"1419993","remark":"　"},"1419994":{"category":"△","subjectId":"1419994","remark":"　"},"1419995":{"category":"△","subjectId":"1419995","remark":"　"},"3102081":{"category":"★","subjectId":"3102081","remark":"◎"},"3102084":{"category":"★","subjectId":"3102084","remark":"◎"},"3102091":{"category":"★","subjectId":"3102091","remark":"◎"},"3102092":{"category":"★","subjectId":"3102092","remark":"◎"},"3102097":{"category":"★","subjectId":"3102097","remark":"◎"},"3103064":{"category":"★","subjectId":"3103064","remark":"◎"},"3201009":{"category":"★","subjectId":"3201009","remark":"◎"},"3601005":{"category":"★","subjectId":"3601005","remark":"◎"},"3601011":{"category":"▲","subjectId":"3601011","remark":"＊"},"3601012":{"category":"▲","subjectId":"3601012","remark":"＊"},"3602051":{"category":"★","subjectId":"3602051","remark":"◎"},"3603051":{"category":"★","subjectId":"3603051","remark":"◎"},"3603053":{"category":"★","subjectId":"3603053","remark":"◎"},"3603054":{"category":"▲","subjectId":"3603054","remark":"＊"},"3603059":{"category":"★","subjectId":"3603059","remark":"◎"},"3603082":{"category":"★","subjectId":"3603082","remark":"◎"},"5901202":{"category":"▲","subjectId":"5901202","remark":"＊"},"5901206":{"category":"★","subjectId":"5901206","remark":"◎"},"5901211":{"category":"★","subjectId":"5901211","remark":"　"},"5902201":{"category":"★","subjectId":"5902201","remark":"◎"},"5902205":{"category":"★","subjectId":"5902205","remark":"　"},"5902206":{"category":"▲","subjectId":"5902206","remark":"■"},"5902207":{"category":"★","subjectId":"5902207","remark":"◎"},"5902209":{"category":"▲","subjectId":"5902209","remark":"■"},"5902301":{"category":"★","subjectId":"5902301","remark":"　"},"5902302":{"category":"★","subjectId":"5902302","remark":"　"},"5902306":{"category":"★","subjectId":"5902306","remark":"　"},"5903202":{"category":"★","subjectId":"5903202","remark":"　"},"5903203":{"category":"▲","subjectId":"5903203","remark":"■"},"5903204":{"category":"▲","subjectId":"5903204","remark":"■"},"5903205":{"category":"★","subjectId":"5903205","remark":"　"},"5903208":{"category":"▲","subjectId":"5903208","remark":"■"},"5903209":{"category":"★","subjectId":"5903209","remark":"　"},"5903301":{"category":"★","subjectId":"5903301","remark":"　"},"5903302":{"category":"★","subjectId":"5903302","remark":"　"},"5903303":{"category":"★","subjectId":"5903303","remark":"　"},"5903304":{"category":"★","subjectId":"5903304","remark":"　"},"5903305":{"category":"★","subjectId":"5903305","remark":"　"},"5903306":{"category":"★","subjectId":"5903306","remark":"　"},"5903307":{"category":"★","subjectId":"5903307","remark":"　"},"5903308":{"category":"★","subjectId":"5903308","remark":"　"},"5903309":{"category":"★","subjectId":"5903309","remark":"　"},"5903311":{"category":"★","subjectId":"5903311","remark":"　"},"5903312":{"category":"★","subjectId":"5903312","remark":"　"},"5903313":{"category":"★","subjectId":"5903313","remark":"　"},"5903314":{"category":"★","subjectId":"5903314","remark":"　"},"5903315":{"category":"★","subjectId":"5903315","remark":"　"},"5903317":{"category":"★","subjectId":"5903317","remark":"　"},"5904202":{"category":"▲","subjectId":"5904202","remark":"■"},"5904301":{"category":"★","subjectId":"5904301","remark":"　"},"5904302":{"category":"★","subjectId":"5904302","remark":"　"},"5904303":{"category":"★","subjectId":"5904303","remark":"　"},"5904304":{"category":"★","subjectId":"5904304","remark":"　"},"5904305":{"category":"★","subjectId":"5904305","remark":"　"},"5904307":{"category":"★","subjectId":"5904307","remark":"　"},"5904308":{"category":"★","subjectId":"5904308","remark":"　"},"5904309":{"category":"★","subjectId":"5904309","remark":"　"},"5904310":{"category":"★","subjectId":"5904310","remark":"　"},"5904312":{"category":"★","subjectId":"5904312","remark":"　"},"5904313":{"category":"★","subjectId":"5904313","remark":"　"},"5904314":{"category":"★","subjectId":"5904314","remark":"　"},"5904315":{"category":"★","subjectId":"5904315","remark":"　"},"5904316":{"category":"★","subjectId":"5904316","remark":"　"},"5904317":{"category":"★","subjectId":"5904317","remark":"　"},"5904319":{"category":"★","subjectId":"5904319","remark":"　"},"5904320":{"category":"★","subjectId":"5904320","remark":"　"},"5904322":{"category":"★","subjectId":"5904322","remark":"　"},"5904325":{"category":"★","subjectId":"5904325","remark":"　"},"5904326":{"category":"★","subjectId":"5904326","remark":"　"},"5904327":{"category":"★","subjectId":"5904327","remark":"　"},"5904335":{"category":"★","subjectId":"5904335","remark":"　"},"5904336":{"category":"★","subjectId":"5904336","remark":"　"},"6502004":{"category":"▲","subjectId":"6502004","remark":"＊"},"6502006":{"category":"★","subjectId":"6502006","remark":"◎"},"6503303":{"category":"★","subjectId":"6503303","remark":"◎"},"6503304":{"category":"★","subjectId":"6503304","remark":"◎"},"6503309":{"category":"★","subjectId":"6503309","remark":"◎"},"6503507":{"category":"▲","subjectId":"6503507","remark":"＊"}} ;
var test;

Ntut = (function(){
	var symbol = {"○": "部訂共同必修", "△": "校訂共同必修", "☆": "共同選修", "●": "部訂專業必修", "▲": "校訂專業必修", "★": "專業選修"};

	function calculate(){
		var subjects;
		var semesters = $("table");
		var items;

		mark(semesters);
		subjects = getSubjects(semesters);
		items = normalAnalysis(subjects, {"○": 0, "△": 0, "☆": 0, "●": 0, "▲": 0, "★": 0});

		console.log(symbol);
		console.log(items);
		console.log(advanceAnalysis(subjects, {"＊": 0, "◎": 0, "■": 0}));
		test = subjects;
	}

	function normalAnalysis(subjects, items){
		for(var i in subjects){
			items[subjects[i].category] += subjects[i].credit;
		}

		return items;
	}

	function advanceAnalysis(subjects, items){// Mark 分析
		for(var i in subjects){
			if(items[subjects[i].remark] != undefined){// 若有此 Mark 則計算
				items[subjects[i].remark] += subjects[i].credit;
			}
		}

		return items;
	}

	function mark(semesters){
		for(var i = 0; i < semesters.length; i++){
			var semester = $(semesters[i]);
			var cell = semester.find("th[align]");

			for(var j = 0; j < cell.length; j += 6){
				$(cell[j]).parent().attr("object", "subject");
			}
		}
	}

	function getSubjects(semesters){
		var result = [];

		console.log("semesters: " + semesters.length);
		for(var i = 0; i < semesters.length; i++){
			var semester = $(semesters[i]);
			var rows = semester.find("tr[object=subject]");

			for(var j = 0; j < rows.length; j++)
			{
				var obj = toSubject(rows[j]);
				if(!isFail(obj)){
					result.push(obj);
				}
			}
		}
		return result;
	}

	function isFail(subject){
		if(!isNaN(subject.score) && subject.score >= 60){
			return false;
		}
		console.log(subject.subjectName + " is Fail");
		return true;
	}

	function toSubject(row){
		var result = {};
		var cells = $(row).find("th");
		var criterion;

		result.courseId = $(cells[0]).html().replace(/\n/g, "").replace(/ /g, "");
		//result.category = $(cells[1]).html().replace(/\n/g, "").replace(/ /g, "");// 要用課程標準中的
		result.category = $(cells[1]).html().replace(/\n/g, "").replace(/ /g, "");
		result.subjectName = $(cells[2]).children("a").html();
		result.subjectId = $(cells[3]).html().replace(/\n/g, "").replace(/ /g, "");
		result.credit = (Number)($(cells[5]).html().replace(/\n/g, "").replace(/ /g, "").replace(".0", ""));
		result.score = $(cells[6]).html().replace(/\n/g, "").replace(/ /g, "");

		// 查詢課程標準的對應符號
		if(result.category == "通"){// 計算博雅選修
			criterion = {category: "△", remark: "　"};
			result.category = criterion.category;
		}
		else if(!criterions[result.subjectId]){// 若查不到則記錄LOG
			console.log("Can't Find: " + result.subjectId + "-" + result.subjectName);
			// 應該還要去對應"課程名稱"可能可以抵免
		}
		else{
			criterion = criterions[result.subjectId];
			result.category = criterion.category;
			result.remark = criterion.remark;// 備註有時會用到
		}
		return result;
	}

	function setCriterions(){
		$.ajax({
			url: "http://aps.ntut.edu.tw/course/tw/Cprog.jsp?format=-4&matric=7",
			data: {
				year: 99,
				division: 823
			}
		}).done(function(xml){
			console.log(xml);
		});
	}

	return{
		calculate: loadCriterions
	}
})();

Ntut.calculate();